<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArcForge - Initiative Tracker</title>
    <link rel="stylesheet" href="css/styles.css?v=4">
</head>
<body>
    <div class="app-container">
        <header>
            <div class="header-left">
                <div class="header-logo">
                    <img src="images/Arc_Logo-48px.png" alt="ArcForge logo" class="logo-image">
                    <button id="dev-restart-btn" class="btn btn-dev" title="Restart Server & Reload">ðŸ”„</button>
                </div>
                <nav class="header-nav">
                    <button id="nav-arena-btn" class="nav-btn active">Arena</button>
                    <button id="nav-crucible-btn" class="nav-btn">Crucible</button>
                    <button id="nav-atlas-btn" class="nav-btn">Atlas</button>
                    <button id="nav-codex-btn" class="nav-btn">Codex</button>
                </nav>
            </div>
            <div class="header-actions">
                <div class="session-encounter-controls">
                    <button id="new-session-btn" class="btn btn-primary">New Session</button>
                    <button id="load-session-btn" class="btn btn-secondary">Load Session</button>
                    <div class="session-info">
                        <span id="current-session-name" class="session-name">No Session</span>
                    </div>
                    <button id="new-encounter-btn" class="btn btn-success">New Encounter</button>
                    <button id="load-encounter-btn" class="btn btn-secondary">Load Encounter</button>
                    <div class="encounter-info">
                        <span id="current-encounter-name" class="encounter-name">No Encounter</span>
                    </div>
                </div>
                <div class="round-display">
                    Round: <span id="round-number">1</span>
                </div>
            </div>
        </header>

        <main id="arena-view">
            <div class="left-panel">
                <section class="agents-list-section">
                    <div class="agents-header">
                        <h2>Agents</h2>
                        <select id="agent-type-filter" class="agent-type-filter">
                            <option value="all">All Types</option>
                            <option value="p">Players</option>
                            <option value="n">NPCs</option>
                            <option value="e">Enemies</option>
                        </select>
                    </div>
                    <button id="create-new-agent-btn" class="btn btn-primary" style="width: 100%; margin-bottom: 1rem;">+ Create New Agent</button>
                    <div id="agents-list" class="agents-list">
                        Loading agents...
                    </div>
                </section>
            </div>

            <div class="right-panel">
                <section class="initiative-tracker">
                    <div class="tracker-header">
                        <h2>Initiative Order</h2>
                        <div class="combat-controls">
                            <button id="start-combat-btn" class="btn btn-success">Start Combat</button>
                            <button id="roll-enemy-initiative-btn" class="btn btn-secondary">Roll Enemy Initiative</button>
                            <button id="next-turn-btn" class="btn btn-primary" style="display: none;">End Turn</button>
                            <button id="end-combat-btn" class="btn btn-danger" style="display: none;">End Combat</button>
                        </div>
                    </div>
                    <div id="combatants-list" class="combatants-list">
                        <div class="empty-state">
                            No agents yet. Add some to start combat!
                        </div>
                    </div>
                </section>
            </div>
        </main>

        <main id="crucible-view" style="display: none;">
            <div class="crucible-layout">
                <div class="codex-container">
                    <div class="codex-tabs" id="crucible-tabs">
                        <button id="crucible-character-btn" class="codex-tab-btn active" data-section="character">Character Builder</button>
                        <button id="crucible-effects-btn" class="codex-tab-btn" data-section="effects">Effects Builder</button>
                        <button id="crucible-items-btn" class="codex-tab-btn" data-section="items">Items</button>
                        <button id="crucible-monsters-btn" class="codex-tab-btn" data-section="monsters">Monsters</button>
                </div>

                <div id="crucible-character-section" class="crucible-section active">
                    <div class="character-builder-container" id="character-builder-container">
                        <section class="character-form-section">
                            <form id="character-form">
                                <!-- Agent Type Selection -->
                                    <div class="form-group agent-type-inline">
                                        <label for="char-agent-type" class="sr-only">Agent Type</label>
                                        <div class="agent-type-select-wrapper">
                                            <select id="char-agent-type" aria-label="Agent Type">
                                        <option value="p">Player Character</option>
                                        <option value="n">NPC</option>
                                        <option value="e">Enemy/Monster</option>
                                    </select>
                                            <span class="agent-type-label">Agent Type</span>
                                        </div>
                                </div>

                                <!-- Basic Info -->
                                <div class="form-section">
                                    <h3>Basic Information</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="char-image">Character Image</label>
                                    <input type="file" id="char-image" accept="image/*">
                                    <input type="hidden" id="char-image-path">
                                    <span id="char-image-status" class="image-status-text"></span>
                                </div>
                                <div class="form-group image-preview-group">
                                    <label>Preview</label>
                                    <img id="char-image-preview" class="image-preview" alt="Character preview" style="display:none;">
                                </div>
                            </div>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="char-name">Character Name *</label>
                                            <input type="text" id="char-name" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="char-race">Race</label>
                                            <select id="char-race">
                                                <option value="">Select Race</option>
                                                <option value="human">Human</option>
                                                <option value="elf">Elf</option>
                                                <option value="dwarf">Dwarf</option>
                                                <option value="halfling">Halfling</option>
                                                <option value="dragonborn">Dragonborn</option>
                                                <option value="gnome">Gnome</option>
                                                <option value="half-elf">Half-Elf</option>
                                                <option value="half-orc">Half-Orc</option>
                                                <option value="tiefling">Tiefling</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="char-class">Class</label>
                                            <select id="char-class">
                                                <option value="">Select Class</option>
                                                <option value="barbarian">Barbarian</option>
                                                <option value="bard">Bard</option>
                                                <option value="cleric">Cleric</option>
                                                <option value="druid">Druid</option>
                                                <option value="fighter">Fighter</option>
                                                <option value="monk">Monk</option>
                                                <option value="paladin">Paladin</option>
                                                <option value="ranger">Ranger</option>
                                                <option value="rogue">Rogue</option>
                                                <option value="sorcerer">Sorcerer</option>
                                                <option value="warlock">Warlock</option>
                                                <option value="wizard">Wizard</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="char-level">Level</label>
                                            <input type="number" id="char-level" min="1" max="20" value="1">
                                        </div>
                                    </div>
                                </div>

                                <!-- Ability Scores -->
                                <div class="form-section">
                                    <h3>Ability Scores</h3>
                                    <div class="ability-scores-grid">
                                        <div class="ability-score-group">
                                            <label for="char-str">STR</label>
                                            <input type="number" id="char-str" min="1" max="30" value="10">
                                            <span class="ability-modifier" id="str-mod">+0</span>
                                        </div>
                                        <div class="ability-score-group">
                                            <label for="char-dex">DEX</label>
                                            <input type="number" id="char-dex" min="1" max="30" value="10">
                                            <span class="ability-modifier" id="dex-mod">+0</span>
                                        </div>
                                        <div class="ability-score-group">
                                            <label for="char-con">CON</label>
                                            <input type="number" id="char-con" min="1" max="30" value="10">
                                            <span class="ability-modifier" id="con-mod">+0</span>
                                        </div>
                                        <div class="ability-score-group">
                                            <label for="char-int">INT</label>
                                            <input type="number" id="char-int" min="1" max="30" value="10">
                                            <span class="ability-modifier" id="int-mod">+0</span>
                                        </div>
                                        <div class="ability-score-group">
                                            <label for="char-wis">WIS</label>
                                            <input type="number" id="char-wis" min="1" max="30" value="10">
                                            <span class="ability-modifier" id="wis-mod">+0</span>
                                        </div>
                                        <div class="ability-score-group">
                                            <label for="char-cha">CHA</label>
                                            <input type="number" id="char-cha" min="1" max="30" value="10">
                                            <span class="ability-modifier" id="cha-mod">+0</span>
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <button type="button" id="standard-array-btn" class="btn btn-secondary btn-small">Standard Array</button>
                                        <button type="button" id="roll-stats-btn" class="btn btn-secondary btn-small">Roll 4d6 Drop Lowest</button>
                                    </div>
                                </div>

                                <!-- Combat Stats -->
                                <div class="form-section">
                                    <h3>Combat Stats</h3>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="char-hp">Max HP</label>
                                            <input type="number" id="char-hp" min="1" value="10">
                                        </div>
                                        <div class="form-group">
                                            <label for="char-ac">Armor Class</label>
                                            <input type="number" id="char-ac" min="1" value="10">
                                        </div>
                                        <div class="form-group">
                                            <label for="char-speed">Speed (ft)</label>
                                            <input type="number" id="char-speed" min="0" value="30">
                                        </div>
                                        <div class="form-group">
                                            <label>Initiative</label>
                                            <span id="char-initiative-mod" class="stat-display">+0</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Skills -->
                                <div class="form-section">
                                    <h3>Skills</h3>
                                    <div class="skills-grid" id="skills-list">
                                        <!-- Skills will be populated by JavaScript -->
                                    </div>
                                </div>

                                <!-- Attacks -->
                                <div class="form-section">
                                    <h3>Attacks</h3>
                                    <div id="attacks-list"></div>
                                    <button type="button" id="add-attack-btn" class="btn btn-secondary btn-small">+ Add Attack</button>
                                </div>

                                <!-- Notes -->
                                <div class="form-section">
                                    <h3>Notes / Features</h3>
                                    <textarea id="char-notes" rows="4" placeholder="Character features, abilities, backstory, etc."></textarea>
                                </div>

                                <div class="form-actions">
                                    <button type="button" id="download-json-btn" class="btn btn-secondary">Download JSON</button>
                                <button type="button" id="download-template-btn" class="btn btn-secondary btn-small">Download Template</button>
                                    <button type="submit" class="btn btn-primary">Save Character</button>
                                    <button type="button" id="clear-form-btn" class="btn btn-secondary">Clear Form</button>
                                </div>
                            </form>
                        </section>

                        <section class="character-list-section">
                            <div class="character-list-header">
                                <h2>Saved Characters</h2>
                                <input type="file" id="upload-json-input" accept=".json" style="display: none;">
                                <button type="button" id="upload-json-btn" class="btn btn-secondary btn-small">Upload JSON</button>
                            </div>
                            <div id="characters-list" class="characters-list">
                                <div class="empty-state">No characters saved yet</div>
                            </div>
                        </section>
                    </div>
                </div>

                <div id="crucible-effects-section" class="crucible-section">
                    <div class="effects-builder-container">
                        <section class="effects-form-section">
                            <h2>Effects Builder</h2>

                            <form id="effects-form">
                                <!-- Basic Info -->
                                <div class="form-section">
                                    <h3>Effect Information</h3>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="effect-name">Effect Name *</label>
                                            <input type="text" id="effect-name" required placeholder="e.g., Bless, Poisoned, Rage">
                                        </div>
                                        <div class="form-group">
                                            <label for="effect-duration">Default Duration (Rounds)</label>
                                            <input type="number" id="effect-duration" min="1" max="100" value="1">
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="effect-description">Description</label>
                                        <textarea id="effect-description" rows="2" placeholder="What does this effect do?"></textarea>
                                    </div>
                                </div>

                                <!-- HP Modifications -->
                                <div class="form-section">
                                    <h3>HP Changes (Per Round)</h3>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="effect-hp-change">HP Change</label>
                                            <input type="number" id="effect-hp-change" placeholder="Positive for healing, negative for damage">
                                        </div>
                                        <div class="form-group">
                                            <label for="effect-hp-timing">Apply When</label>
                                            <select id="effect-hp-timing">
                                                <option value="start">Start of Turn</option>
                                                <option value="end">End of Turn</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Roll Modifiers -->
                                <div class="form-section">
                                    <h3>Roll Modifiers</h3>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="effect-attack-mod">Attack Roll Modifier</label>
                                            <select id="effect-attack-mod">
                                                <option value="none">None</option>
                                                <option value="advantage">Advantage</option>
                                                <option value="disadvantage">Disadvantage</option>
                                                <option value="bonus">Bonus (numeric)</option>
                                                <option value="penalty">Penalty (numeric)</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="effect-attack-value">Value (if bonus/penalty)</label>
                                            <input type="number" id="effect-attack-value" placeholder="e.g., +2 or -2">
                                        </div>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="effect-save-mod">Saving Throw Modifier</label>
                                            <select id="effect-save-mod">
                                                <option value="none">None</option>
                                                <option value="advantage">Advantage</option>
                                                <option value="disadvantage">Disadvantage</option>
                                                <option value="bonus">Bonus (numeric)</option>
                                                <option value="penalty">Penalty (numeric)</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="effect-save-value">Value (if bonus/penalty)</label>
                                            <input type="number" id="effect-save-value" placeholder="e.g., +2 or -2">
                                        </div>
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="effect-ability-mod">Ability Check Modifier</label>
                                            <select id="effect-ability-mod">
                                                <option value="none">None</option>
                                                <option value="advantage">Advantage</option>
                                                <option value="disadvantage">Disadvantage</option>
                                                <option value="bonus">Bonus (numeric)</option>
                                                <option value="penalty">Penalty (numeric)</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="effect-ability-value">Value (if bonus/penalty)</label>
                                            <input type="number" id="effect-ability-value" placeholder="e.g., +2 or -2">
                                        </div>
                                    </div>
                                </div>

                                <!-- Stat Modifiers -->
                                <div class="form-section">
                                    <h3>Stat Modifiers</h3>
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="effect-ac-mod">AC Modifier</label>
                                            <input type="number" id="effect-ac-mod" placeholder="e.g., +2 or -2">
                                        </div>
                                        <div class="form-group">
                                            <label for="effect-speed-mod">Speed Modifier</label>
                                            <input type="number" id="effect-speed-mod" placeholder="e.g., +10 or -10">
                                        </div>
                                    </div>
                                </div>

                                <!-- Special Conditions -->
                                <div class="form-section">
                                    <h3>Special Conditions</h3>
                                    <div class="conditions-grid">
                                        <label class="condition-checkbox">
                                            <input type="checkbox" id="effect-incapacitated">
                                            <span>Incapacitated</span>
                                        </label>
                                        <label class="condition-checkbox">
                                            <input type="checkbox" id="effect-unconscious">
                                            <span>Unconscious</span>
                                        </label>
                                        <label class="condition-checkbox">
                                            <input type="checkbox" id="effect-stunned">
                                            <span>Stunned</span>
                                        </label>
                                        <label class="condition-checkbox">
                                            <input type="checkbox" id="effect-paralyzed">
                                            <span>Paralyzed</span>
                                        </label>
                                        <label class="condition-checkbox">
                                            <input type="checkbox" id="effect-restrained">
                                            <span>Restrained</span>
                                        </label>
                                        <label class="condition-checkbox">
                                            <input type="checkbox" id="effect-blinded">
                                            <span>Blinded</span>
                                        </label>
                                        <label class="condition-checkbox">
                                            <input type="checkbox" id="effect-deafened">
                                            <span>Deafened</span>
                                        </label>
                                        <label class="condition-checkbox">
                                            <input type="checkbox" id="effect-invisible">
                                            <span>Invisible</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="form-actions">
                                    <button type="submit" class="btn btn-primary">Save Effect</button>
                                    <button type="button" id="clear-effect-btn" class="btn btn-secondary">Clear Form</button>
                                </div>
                            </form>
                        </section>

                        <section class="effects-list-section">
                            <h2>Saved Effects</h2>
                            <div id="effects-list" class="effects-list">
                                <div class="empty-state">No effects created yet</div>
                            </div>
                        </section>
                    </div>
                </div>

                    <div id="crucible-items-section" class="crucible-section">
                        <div class="items-container">
                            <div class="items-header">
                                <h2>Item Catalog</h2>
                                <div class="items-controls">
                                    <input type="text" id="item-search-input" class="form-input" placeholder="Search items..." aria-label="Search items">
                                    <label for="item-category-filter">Category</label>
                                    <select id="item-category-filter" class="form-input"></select>
                                </div>
                            </div>
                            <div class="items-content">
                                <div class="item-list" id="item-list"></div>
                                <aside class="item-detail" id="item-detail">
                                    <div class="item-detail-empty">Select an item to view details.</div>
                                </aside>
                            </div>
                        </div>
                    </div>

                    <div id="crucible-monsters-section" class="crucible-section">
                        <div class="monsters-container">
                            <div class="monsters-header">
                                <h2>Monster Library</h2>
                                <div class="monsters-controls">
                                    <input type="text" id="monster-search-input" class="form-input" placeholder="Search monsters..." aria-label="Search monsters">
                                    <label for="monster-category-filter">Category</label>
                                    <select id="monster-category-filter" class="form-input"></select>
                        </div>
                            </div>
                            <div class="monsters-content">
                                <div class="monster-list" id="monster-list"></div>
                                <aside class="monster-detail" id="monster-detail">
                                    <div class="monster-detail-empty">Select a monster to view details.</div>
                                </aside>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <main id="atlas-view" style="display: none;">
            <div class="codex-container">
                <div class="codex-tabs" id="atlas-tabs">
                    <button class="codex-tab-btn active" data-atlas-section="map">Map</button>
                    <button class="codex-tab-btn" data-atlas-section="encounters">Encounters</button>
                    <button class="codex-tab-btn" data-atlas-section="control">Control</button>
                </div>

                <section id="atlas-map-section" class="atlas-section active">
                    <div class="atlas-map-layout">
                        <aside class="atlas-map-library">
                            <header class="atlas-panel-header">
                                <h3>Map Library</h3>
                                <label class="atlas-upload-btn">
                                    <input type="file" id="atlas-map-upload-input" accept=".png,.jpg,.jpeg,.webp" multiple>
                                    <span>Upload</span>
                                </label>
                            </header>
                            <div id="atlas-map-list" class="atlas-list">
                                <div class="atlas-empty-state">Upload a map to get started.</div>
                            </div>
                            <a href="http://localhost:3001/display" target="_blank" rel="noopener" class="btn btn-secondary atlas-open-display">Open Player Display</a>
                        </aside>

                        <section class="atlas-map-settings">
                            <header class="atlas-panel-header">
                                <h3>Display Settings</h3>
                                <div class="atlas-display-status-wrapper">
                                    <div id="atlas-display-status" class="atlas-status atlas-status-disconnected">Display not connected</div>
                                    <button id="atlas-refresh-status-btn" class="btn btn-small btn-secondary" title="Refresh connection status">ðŸ”„</button>
                                </div>
                            </header>

                            <div class="atlas-settings-group">
                                <h4>Resolution</h4>
                                <div class="atlas-settings-grid">
                                    <label>
                                        Width (px)
                                        <input type="number" id="atlas-resolution-width" min="1" step="1">
                                    </label>
                                    <label>
                                        Height (px)
                                        <input type="number" id="atlas-resolution-height" min="1" step="1">
                                    </label>
                                    <label>
                                        Refresh Rate (Hz)
                                        <input type="number" id="atlas-refresh-rate" min="1" step="1" placeholder="Optional">
                                    </label>
                                </div>
                            </div>

                            <div class="atlas-settings-group">
                                <h4>Physical Size</h4>
                                <div class="atlas-settings-grid">
                                    <label>
                                        Diagonal (in)
                                        <input type="number" id="atlas-diagonal" min="1" step="0.1" value="42">
                                    </label>
                                    <label>
                                        Pixels Per Inch
                                        <input type="number" id="atlas-ppi" min="1" step="0.01" placeholder="Auto" disabled>
                                    </label>
                                </div>
                                <div class="atlas-settings-actions">
                                    <button id="atlas-auto-calibrate-btn" class="btn btn-secondary">Auto Compute</button>
                                    <button id="atlas-manual-calibrate-btn" class="btn btn-secondary">Manual Calibrate</button>
                                </div>
                            </div>

                            <div class="atlas-settings-group">
                                <h4>Grid</h4>
                                <div class="atlas-settings-grid">
                                    <label>
                                        Grid Size (in)
                                        <input type="number" id="atlas-grid-inches" min="0.1" step="0.05" value="1">
                                    </label>
                                    <label>
                                        Line Width (px)
                                        <input type="number" id="atlas-grid-line" min="1" step="1" value="2">
                                    </label>
                                    <label>
                                        Opacity
                                        <input type="number" id="atlas-grid-opacity" min="0" max="1" step="0.05" value="0.25">
                                    </label>
                                    <label>
                                        Color
                                        <input type="color" id="atlas-grid-color" value="#3aaaff">
                                    </label>
                                </div>
                                <label class="atlas-checkbox">
                                    <input type="checkbox" id="atlas-grid-enabled" checked>
                                    <span>Show grid on display</span>
                                </label>
                            </div>

                            <div class="atlas-settings-actions">
                                <button id="atlas-push-display-btn" class="btn btn-success">Push to Display</button>
                            </div>
                        </section>

                        <section class="atlas-map-preview">
                            <header class="atlas-panel-header">
                                <h3>Active Map Preview</h3>
                                <div class="atlas-preview-controls">
                                    <label class="atlas-checkbox">
                                        <input type="checkbox" id="atlas-preview-grid" checked>
                                        <span>Show Grid</span>
                                    </label>
                                    <select id="atlas-preview-fit">
                                        <option value="fit">Fit</option>
                                        <option value="fill">Fill</option>
                                        <option value="stretch">Stretch</option>
                                        <option value="pixel">1:1 Pixel</option>
                                    </select>
                                    <div class="atlas-zoom-controls">
                                        <span class="zoom-label">Map:</span>
                                        <button type="button" id="atlas-preview-zoom-out" class="btn btn-secondary btn-small">â€“</button>
                                        <button type="button" id="atlas-preview-zoom-in" class="btn btn-secondary btn-small">+</button>
                                        <button type="button" id="atlas-preview-zoom-reset" class="btn btn-secondary btn-small">Reset</button>
                                        <span class="zoom-separator">|</span>
                                        <span class="zoom-label">Grid:</span>
                                        <button type="button" id="atlas-grid-zoom-out" class="btn btn-secondary btn-small">â€“</button>
                                        <button type="button" id="atlas-grid-zoom-in" class="btn btn-secondary btn-small">+</button>
                                        <button type="button" id="atlas-grid-zoom-reset" class="btn btn-secondary btn-small">Reset</button>
                                    </div>
                                </div>
                            </header>
                            <div class="atlas-preview-canvas-wrapper">
                                <canvas id="atlas-preview-canvas"></canvas>
                                <div id="atlas-preview-empty" class="atlas-empty-state">Select a map to preview.</div>
                            </div>
                        </section>
                    </div>
                </section>

                <section id="atlas-encounters-section" class="atlas-section">
                    <div class="atlas-encounter-container">
                        <header class="atlas-panel-header atlas-encounter-header">
                            <h3>Encounter Setup</h3>
                            <div class="atlas-encounter-actions">
                                <div class="atlas-zoom-controls">
                                    <span class="zoom-label">Zoom</span>
                                    <button type="button" id="atlas-encounter-zoom-out" class="btn btn-secondary btn-small">-</button>
                                    <button type="button" id="atlas-encounter-zoom-in" class="btn btn-secondary btn-small">+</button>
                                    <button type="button" id="atlas-encounter-zoom-reset" class="btn btn-secondary btn-small">Reset</button>
                                </div>
                                <div class="atlas-grid-controls">
                                    <span class="zoom-label">Grid</span>
                                    <button type="button" id="atlas-encounter-grid-out" class="btn btn-secondary btn-small">-</button>
                                    <button type="button" id="atlas-encounter-grid-in" class="btn btn-secondary btn-small">+</button>
                                    <button type="button" id="atlas-encounter-grid-reset" class="btn btn-secondary btn-small">Reset</button>
                                </div>
                                <button type="button" id="atlas-start-area-place" class="btn btn-secondary btn-small">Place Starting Area</button>
                                <button type="button" id="atlas-start-area-clear" class="btn btn-secondary btn-small">Clear</button>
                                <button type="button" id="atlas-start-area-save" class="btn btn-primary btn-small">Save</button>
                            </div>
                        </header>
                        <div class="atlas-encounter-stage">
                            <canvas id="atlas-encounter-canvas"></canvas>
                            <div id="atlas-encounter-empty" class="atlas-empty-state">Select an active map to configure the encounter.</div>
                            <div id="atlas-start-area-hint" class="atlas-start-area-hint">Click Place Starting Area or drag the map to choose where the display begins.</div>
                        </div>
                        <footer class="atlas-encounter-footer">
                            <div class="atlas-start-area-metrics">
                                <span><strong>Display:</strong> <span id="atlas-start-area-resolution">--</span></span>
                                <span><strong>Top-left:</strong> <span id="atlas-start-area-coords">--</span></span>
                                <span><strong>Grid:</strong> <span id="atlas-start-area-grid">--</span></span>
                            </div>
                            <div id="atlas-start-area-status" class="atlas-start-area-status">Select an active map to begin.</div>
                        </footer>
                    </div>
                </section>
                <section id="atlas-control-section" class="atlas-section">
                    <div class="atlas-section-placeholder">Control center coming soon.</div>
                </section>
            </div>
        </main>

        <main id="codex-view" style="display: none;">
            <div class="codex-container">
                <div class="codex-tabs">
                    <button class="codex-tab-btn active" data-codex-section="character">Character Sheets</button>
                    <button class="codex-tab-btn" data-codex-section="enemy">Enemy Sheets</button>
                    <button class="codex-tab-btn" data-codex-section="journal">Journal</button>
                </div>

                <section id="codex-character-section" class="codex-section active">
                    <div class="codex-sheets-layout">
                        <div class="codex-sheet-list" id="codex-character-list">
                            <div class="empty-state">No characters selected</div>
                        </div>
                        <div class="codex-sheet-detail" id="codex-character-detail">
                            <div class="empty-state">Choose a character to view their sheet</div>
                        </div>
                    </div>
                </section>

                <section id="codex-enemy-section" class="codex-section">
                    <div class="codex-sheets-layout">
                        <div class="codex-sheet-list" id="codex-enemy-list">
                            <div class="empty-state">No enemies available</div>
                        </div>
                        <div class="codex-sheet-detail" id="codex-enemy-detail">
                            <div class="empty-state">Choose an enemy to view their sheet</div>
                        </div>
                    </div>
                </section>

                <section id="codex-journal-section" class="codex-section">
                    <div class="codex-journal">
                        <div class="codex-journal-list" id="codex-journal-list">
                            <div class="empty-state">No journal entries yet</div>
                        </div>
                        <div class="codex-journal-editor">
                            <textarea id="codex-journal-text" placeholder="Select or create a journal entry to begin writing..."></textarea>
                            <div class="codex-journal-actions">
                                <button class="btn btn-primary" id="codex-journal-save-btn">Save Entry</button>
                                <button class="btn btn-secondary" id="codex-journal-new-btn">New Entry</button>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>

        <main id="effects-view" style="display: none;">
            <div class="effects-builder-container">
                <section class="effects-form-section">
                    <h2>Effects Builder</h2>

                    <form id="effects-form">
                        <!-- Basic Info -->
                        <div class="form-section">
                            <h3>Effect Information</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="effect-name">Effect Name *</label>
                                    <input type="text" id="effect-name" required placeholder="e.g., Bless, Poisoned, Rage">
                                </div>
                                <div class="form-group">
                                    <label for="effect-duration">Default Duration (Rounds)</label>
                                    <input type="number" id="effect-duration" min="1" max="100" value="1">
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="effect-description">Description</label>
                                <textarea id="effect-description" rows="2" placeholder="What does this effect do?"></textarea>
                            </div>
                        </div>

                        <!-- HP Modifications -->
                        <div class="form-section">
                            <h3>HP Changes (Per Round)</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="effect-hp-change">HP Change</label>
                                    <input type="number" id="effect-hp-change" placeholder="Positive for healing, negative for damage">
                                </div>
                                <div class="form-group">
                                    <label for="effect-hp-timing">Apply When</label>
                                    <select id="effect-hp-timing">
                                        <option value="start">Start of Turn</option>
                                        <option value="end">End of Turn</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Roll Modifiers -->
                        <div class="form-section">
                            <h3>Roll Modifiers</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="effect-attack-mod">Attack Roll Modifier</label>
                                    <select id="effect-attack-mod">
                                        <option value="none">None</option>
                                        <option value="advantage">Advantage</option>
                                        <option value="disadvantage">Disadvantage</option>
                                        <option value="bonus">Bonus (numeric)</option>
                                        <option value="penalty">Penalty (numeric)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="effect-attack-value">Value (if bonus/penalty)</label>
                                    <input type="number" id="effect-attack-value" placeholder="e.g., +2 or -2">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="effect-save-mod">Saving Throw Modifier</label>
                                    <select id="effect-save-mod">
                                        <option value="none">None</option>
                                        <option value="advantage">Advantage</option>
                                        <option value="disadvantage">Disadvantage</option>
                                        <option value="bonus">Bonus (numeric)</option>
                                        <option value="penalty">Penalty (numeric)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="effect-save-value">Value (if bonus/penalty)</label>
                                    <input type="number" id="effect-save-value" placeholder="e.g., +2 or -2">
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="effect-ability-mod">Ability Check Modifier</label>
                                    <select id="effect-ability-mod">
                                        <option value="none">None</option>
                                        <option value="advantage">Advantage</option>
                                        <option value="disadvantage">Disadvantage</option>
                                        <option value="bonus">Bonus (numeric)</option>
                                        <option value="penalty">Penalty (numeric)</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="effect-ability-value">Value (if bonus/penalty)</label>
                                    <input type="number" id="effect-ability-value" placeholder="e.g., +2 or -2">
                                </div>
                            </div>
                        </div>

                        <!-- Stat Modifiers -->
                        <div class="form-section">
                            <h3>Stat Modifiers</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="effect-ac-mod">AC Modifier</label>
                                    <input type="number" id="effect-ac-mod" placeholder="e.g., +2 or -2">
                                </div>
                                <div class="form-group">
                                    <label for="effect-speed-mod">Speed Modifier</label>
                                    <input type="number" id="effect-speed-mod" placeholder="e.g., +10 or -10">
                                </div>
                            </div>
                        </div>

                        <!-- Special Conditions -->
                        <div class="form-section">
                            <h3>Special Conditions</h3>
                            <div class="conditions-grid">
                                <label class="condition-checkbox">
                                    <input type="checkbox" id="effect-incapacitated">
                                    <span>Incapacitated</span>
                                </label>
                                <label class="condition-checkbox">
                                    <input type="checkbox" id="effect-unconscious">
                                    <span>Unconscious</span>
                                </label>
                                <label class="condition-checkbox">
                                    <input type="checkbox" id="effect-stunned">
                                    <span>Stunned</span>
                                </label>
                                <label class="condition-checkbox">
                                    <input type="checkbox" id="effect-paralyzed">
                                    <span>Paralyzed</span>
                                </label>
                                <label class="condition-checkbox">
                                    <input type="checkbox" id="effect-restrained">
                                    <span>Restrained</span>
                                </label>
                                <label class="condition-checkbox">
                                    <input type="checkbox" id="effect-blinded">
                                    <span>Blinded</span>
                                </label>
                                <label class="condition-checkbox">
                                    <input type="checkbox" id="effect-deafened">
                                    <span>Deafened</span>
                                </label>
                                <label class="condition-checkbox">
                                    <input type="checkbox" id="effect-invisible">
                                    <span>Invisible</span>
                                </label>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Save Effect</button>
                            <button type="button" id="clear-effect-btn" class="btn btn-secondary">Clear Form</button>
                        </div>
                    </form>
                </section>

                <section class="effects-list-section">
                    <h2>Saved Effects</h2>
                    <div id="effects-list" class="effects-list">
                        <div class="empty-state">No effects created yet</div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <main id="loot-view" style="display: none;">
        <div class="loot-container">
            <div class="loot-header">
                <h2>Loot Distribution</h2>
                <button id="distribute-gold-btn" class="btn btn-success">Distribute Gold</button>
            </div>
            <div class="loot-main">
                <div class="loot-pool-section">
                    <h3>Collected Loot</h3>
                    <div id="loot-pool" class="loot-pool"></div>
                </div>
                <div class="party-inventory-section">
                    <h3>Party Inventory</h3>
                    <div id="party-inventory" class="party-inventory"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Attack Modal -->
    <div id="attack-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="attack-modal-title">Attacks</h2>
                <button class="modal-close" onclick="closeAttackModal()">&times;</button>
            </div>
            <div id="attack-modal-body" class="modal-body">
                <!-- Attacks will be populated here -->
            </div>
        </div>
    </div>

    <!-- Session Management Modal -->
    <div id="session-modal" class="modal" style="display: none;">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2 id="session-modal-title">Session Management</h2>
                <button class="modal-close" onclick="closeSessionModal()">&times;</button>
            </div>
            <div id="session-modal-body" class="modal-body">
                <div class="session-modal-layout">
                    <div class="session-form-section">
                        <h3>Create New Session</h3>
                        <form id="session-form">
                            <div class="form-group">
                                <label for="session-name-input">Session Name *</label>
                                <input type="text" id="session-name-input" required placeholder="e.g., The Lost Mines - Session 4">
                            </div>
                            <div class="form-group">
                                <label for="session-description-input">Description</label>
                                <textarea id="session-description-input" rows="3" placeholder="Campaign notes, goals for today..."></textarea>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">Create Session</button>
                                <button type="button" class="btn btn-secondary" onclick="closeSessionModal()">Cancel</button>
                            </div>
                        </form>
                    </div>
                    <div class="session-list-section">
                        <h3>Saved Sessions</h3>
                        <div id="sessions-list" class="sessions-list">
                            <div class="empty-state">No sessions saved yet</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Encounter Management Modal -->
    <div id="encounter-modal" class="modal" style="display: none;">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h2 id="encounter-modal-title">Encounter Management</h2>
                <button class="modal-close" onclick="closeEncounterModal()">&times;</button>
            </div>
            <div id="encounter-modal-body" class="modal-body">
                <div class="encounter-modal-layout">
                    <div class="encounter-form-section">
                        <h3>Create New Encounter</h3>
                        <form id="encounter-form">
                            <div class="form-group">
                                <label for="encounter-name-input">Encounter Name *</label>
                                <input type="text" id="encounter-name-input" required placeholder="e.g., Goblin Ambush">
                            </div>
                            <div class="form-group">
                                <label for="encounter-map-select">Associated Map</label>
                                <select id="encounter-map-select">
                                    <option value="">No Map</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="encounter-description-input">Description</label>
                                <textarea id="encounter-description-input" rows="3" placeholder="Notes about this encounter..."></textarea>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-success">Create Encounter</button>
                                <button type="button" class="btn btn-secondary" onclick="closeEncounterModal()">Cancel</button>
                            </div>
                        </form>
                    </div>
                    <div class="encounter-list-section">
                        <h3>Encounters in Current Session</h3>
                        <div id="encounters-list" class="encounters-list">
                            <div class="empty-state">No encounters in this session</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/session-manager.js?v=1"></script>
    <script src="js/app.js?v=16"></script>
    <script src="js/character-builder.js?v=3"></script>
    <script src="js/effects-builder.js?v=2"></script>
    <script src="js/loot-manager.js?v=2"></script>
    <script src="js/data-manager.js?v=2"></script>
</body>
</html>
